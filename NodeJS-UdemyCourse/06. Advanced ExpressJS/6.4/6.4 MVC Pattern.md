# 6.4 MVC Pattern [ 26/05/2025 ]

---

<aside>
💡

NOTE:

---

- What will be the type of the data definition here ?
</aside>

## MVC

- **MVC** → **Model-View-Controller**,
- `MVC` → A **design pattern** that divides application logic into three interconnected components:
    - Model → Handles data and business logic
    - View → Handles the UI
    - Controller → Handles user input, interacts with models, and returns views
- Node.js doesn’t enforce MVC,
    - but **Express.js**, is often structured using MVC to keep code modular and maintainable.
- It promotes
    - separation of concerns by dividing an application into three distinct, interconnected components:
    - Reusability
    - Code maintenance and debugging
    - Scalability

Flow of a Request

1. **User sends a request** → `/users`
2. **Router** forwards it to the appropriate **controller**
3. **Controller** calls the **model** to fetch or update data
4. **Controller** sends the result to the **view** (or directly as JSON)
5. **View** renders the response for the user

Controller:

- A **controller** is a function responsible for:
    - Processing the request (e.g. fetching data)
    - Applying business logic
    - Returning a **response** (HTML, JSON, redirect, etc.)

## Controller ( vs ) Middleware

| Feature | **Controller** | **Middleware** |
| --- | --- | --- |
| **Main Purpose** | Handle **business logic** and return a response | Handle **pre-processing** or **post-processing** tasks |
| **Position** | Usually at the **end** of middleware chain | Executed **before**, **between**, or even **after** controllers |
| **Request Handling** | Sends the final response (e.g., HTML, JSON) | Passes control using `next()` or ends the request |
| **Typical Use** | Routing logic, calling models, rendering views | Authentication, logging, validation, parsing, CORS, etc. |
| **Returns Response?** | ✅ Usually ends the request | ❌ Often doesn’t return a response directly |

## Refactor the Code for MVC

```jsx
// index.js
const express = require('express');

const booksRouter = require('./routes/books.routes');
const loggerMiddleware = require('./middlewares/logger');

const app = express();
const PORT = 8000;

// To Parse & Store the req data 
app.use(express.json());

// Middleware fn to log every request
app.use(loggerMiddleware);

// Router
app.use('/books', booksRouter);

app.listen(PORT, () => console.log(`Server is Running on PORT: ${PORT}`));
```

```jsx
// books.js
exports.BOOKS = [
        { id: 1, title: 'Book One', author: 'Author One' },
        { id: 2, title: 'Book Two', author: 'Author Two' },
];
```

```jsx
// logger.js
const fs = require('node:fs');

function loggerMiddleware (req, res, next) {
    const logMessage = `[${Date.now()}]: ${req.method} ${req.path} \n`
    fs.appendFileSync('logs.txt', logMessage, 'utf-8');
    next()
}

module.exports = loggerMiddleware;
```

```jsx
// books.routes.js
const express = require('express');
const controllers = require('../controllers/book.controller');

const router = express.Router();

// Route to GET all Books
router.get('/', controllers.getAllBooks)

// Route to fetch a Book by ID
router.get('/:id', controllers.getBookByID)

// Route to POST a New Book
router.post('/', controllers.postNewBook)

// Route to DELETE a Book by ID
router.delete('/:id', controllers.deleteBookByID)

// export router
module.exports = router;
```

```jsx
// books.controller.js
const { BOOKS } = require('../models/books');

exports.getAllBooks = (req, res) => {
    res.json(BOOKS);
}

exports.getBookByID = (req, res) => {
    const id = parseInt(req.params.id);
    
    // send response if ID is NAN
    if (isNaN(id)) {
        return res.status(400).json({error: "Book ID must be of Type Number"});
    }

    // Find the book
    const book = BOOKS.find((i) => {return i.id === id});

    // if book not found
    if (!book) {
        return res.status(404).json({error: `Book with id:${id} is NOT found`});
    }

    // Send response
    return res.json(book);
}

exports.postNewBook = (req, res) => {
    const {title, author} = req.body;

    // Condition where title or author is missing in Req
    if (!title) {
        return res.status(400).json({error: "title of the book is Missing"});
    }
    if (!author) {
        return res.status(400).json({error: "author of the book is Missing"});
    }
    
    const id = BOOKS.length + 1;
    const book = {id, title, author};
    BOOKS.push(book);

    return res.status(201).json({Message: `Book with id:${id} is Inserted`});
}

exports.deleteBookByID = (req, res) => {
    const id = parseInt(req.params.id);
    
    // send response if ID is NAN
    if (isNaN(id)) {
        return res.status(400).json({error: "Book ID must be of Type Number"});
    }

    // Find the book
    const indexToDelete = BOOKS.findIndex((i) => {return i.id === id});

    // if book not found
    if (indexToDelete < 0) {
        return res.status(404).json({error: `Book with id:${id} is NOT found`});
    }

    BOOKS.splice(indexToDelete, 1);
    return res.json({Message: `Book with id:${id} is Deleted Successfully`});
}
```